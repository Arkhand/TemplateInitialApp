/*!
 * OpenUI5
 * (c) Copyright 2009-2022 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/base/util/array/diff','sap/ui/base/Object','sap/base/util/merge','sap/base/util/deepEqual','sap/m/p13n/SelectionPanel','sap/m/p13n/modules/xConfigAPI'],function(d,B,m,a,S,x){"use strict";var b=B.extend("sap.m.p13n.SelectionController",{constructor:function(s){B.call(this);this._oAdaptationControl=s.control;if(!this._oAdaptationControl){throw new Error("Always provide atleast a 'control' configuration when creating a new p13n controller!");}this._sTargetAggregation=s.targetAggregation;this._fSelector=s.selector;this._oP13nData=null;this._bLiveMode=false;this._bResetEnabled=false;this._bReorderingEnabled=s.hasOwnProperty("enableReorder")?s.enableReorder:true;}});b.prototype.getAdaptationControl=function(){return this._oAdaptationControl;};b.prototype.getTargetAggregation=function(){return this._sTargetAggregation;};b.prototype.getChangeOperations=function(){return{add:"addItem",remove:"removeItem",move:"moveItem"};};b.prototype.getSelectorForReset=function(){return this._oAdaptationControl;};b.prototype.sanityCheck=function(s){return s;};b.prototype.initAdaptationUI=function(p){var A=this.mixInfoAndState(p);this._oPanel=this.createUI(A);return Promise.resolve(this._oPanel);};b.prototype.createUI=function(A){var s=new S({showHeader:true,enableCount:true});s.setEnableReorder(this._bReorderingEnabled);return s.setP13nData(A.items);};b.prototype.getCurrentState=function(){var s=[],A=this.getAdaptationControl().getAggregation(this.getTargetAggregation())||[];A.forEach(function(I,e){var R=this._fSelector?this._fSelector({key:I.getId()}):I.getVisible();if(R){s.push({key:I.getId()});}}.bind(this));var X=x.readConfig(this.getAdaptationControl())||{};var i=X.hasOwnProperty("aggregations")?X.aggregations[this._sTargetAggregation]:{};for(var k in i){var c=s.map(function(o){return o.key;});var C=c.indexOf(k);var n=i[k].position;var v=i[k].visible!==false;var r=n!==undefined;if(v&&C===-1){s.push({key:k});}if(v&&r&&s.length>0){var I=s.splice(C,1)[0];s.splice(n,0,I);C=n;}if(i[k].visible===false&&C>-1){s.splice(C,1);}}return s;};b.prototype.getStateKey=function(){return"items";};b.prototype.getDelta=function(p){var P=this._getPresenceAttribute(p.externalAppliance);var n;var f=function(i){return i.hasOwnProperty(P)&&i[P]===false?false:true;};n=p.applyAbsolute?p.changedState.filter(f):this._getFilledArray(p.existingState,p.changedState,P).filter(f);p.changedState=n;if(a(p.existingState,n)){return[];}else{return this.getArrayDeltaChanges(p);}};b.prototype.getArrayDeltaChanges=function(D){var e=D.existingState;var c=D.changedState;var C=D.control;var i=D.changeOperations.add;var r=D.changeOperations.remove;var M=D.changeOperations.move;var g=D.generator;var f=D.deltaAttributes||[];var s=function(o){var k="";f.forEach(function(A){k=k+o[A];});return k;};var R=d(e,c,s);var h=function(F,A){return A.filter(function(E){return E&&(E.key===F.key);})[0];};var j=[];var p=e.slice(0);R.forEach(function(o){if(o.type==="delete"&&p[o.index]===undefined){p.splice(o.index,1);return;}var P,E,l;if(o.type==="insert"){E=h(c[o.index],p);if(E){E.index=p.indexOf(E);p.splice(E.index,1,undefined);j=j.concat(this._createAddRemoveChange(C,r,this._getChangeContent(E,f),g));}}P=o.type==="delete"?p[o.index]:c[o.index];P.index=o.index;if(o.type==="delete"){p.splice(P.index,1);}else{p.splice(P.index,0,P);}if(M){l=j.length;if(l){E=j[l-1];E=E?E.changeSpecificData.content:undefined;}if(E&&E.key===P.key&&o.index!=E.index){j.pop();j=j.concat(this._createMoveChange(E.id,E.key,o.index,M,C,M!=="moveSort",g));return;}}j=j.concat(this._createAddRemoveChange(C,o.type==="delete"?r:i,this._getChangeContent(P,f),g));}.bind(this));return j;};b.prototype._getChangeContent=function(p,D){var c={};if(p.index>=0){c.index=p.index;}D.forEach(function(A){if(p.hasOwnProperty(A)){c[A]=p[A];}});return c;};b.prototype._createAddRemoveChange=function(c,o,C){var A={selectorElement:c,changeSpecificData:{changeType:o,content:{key:C.key,targetAggregation:this.getTargetAggregation(),index:C.index,value:o===this.getChangeOperations()["add"]}}};return A;};b.prototype._createMoveChange=function(i,p,n,M,c,P){var o={selectorElement:c,changeSpecificData:{changeType:M,content:{key:p,targetAggregation:this.getTargetAggregation(),index:n}}};return o;};b.prototype._getPresenceAttribute=function(c){return"visible";};b.prototype.getBeforeApply=function(){return Promise.resolve();};b.prototype.mixInfoAndState=function(p){var i=this.getCurrentState();var I=this.arrayToMap(i);var P=this.prepareAdaptationData(p,function(c,o){var e=I[o.key];c.visible=this._fSelector?this._fSelector(o):(!!e);c.position=e?e.position:-1;return!(o.visible===false);}.bind(this));this.sortP13nData({visible:"visible",position:"position"},P.items);P.items.forEach(function(o){delete o.position;});return P;};b.prototype.getP13nData=function(){return this._oPanel?this._oPanel.getP13nData():this._oAdaptationModel.getProperty("/items");};b.prototype.model2State=false;b.prototype.update=function(p){if(this._oPanel){var A=this.mixInfoAndState(p);this._oPanel.setP13nData(A.items);}else if(this._oAdaptationModel){var P=this.mixInfoAndState(p);this._oAdaptationModel.setProperty("/items",P.items);this._oAdaptationModel.setProperty("/itemsGrouped",P.itemsGrouped);}};b.prototype._getFilledArray=function(p,n,r){var N=m([],p);var c=m([],n);var e=this.arrayToMap(p);c.forEach(function(i){var E=e[i.key];if(!i.hasOwnProperty(r)||i[r]){var f=i.position;if(E){f=f>-1?f:E.position;var o=E.position;N.splice(f,0,N.splice(o,1)[0]);}else{f=f>-1?f:N.length;N.splice(f,0,i);}N[f]=i;}else if(E){N[E.position][r]=false;}});return N;};b.prototype.changesToState=function(c){var s=[];c.forEach(function(C){var o=m({},C.changeSpecificData.content);var i=o.index;delete o.index;if(C.changeSpecificData.changeType===this.getChangeOperations()["move"]){o.position=i;}if(C.changeSpecificData.changeType===this.getChangeOperations()["remove"]){o[this._getPresenceAttribute()]=false;}s.push(o);}.bind(this));return s;};b.prototype.prepareAdaptationData=function(p,e,g){var i=[];var I=g?{}:null;var E=e instanceof Function;p.getProperties().forEach(function(P){var c={};if(E){var f=e(c,P);if(!f){return;}}c.key=P.key;c.name=P.key;c.label=P.label||P.key;c.tooltip=P.tooltip;if(I){c.group=P.group?P.group:"BASIC";c.groupLabel=P.groupLabel;I[c.group]=I[c.group]?I[c.group]:[];I[c.group].push(c);}i.push(c);});var A={items:i};if(I){A.itemsGrouped=this._buildGroupStructure(I);}return A;};b.prototype.sortP13nData=function(s,i){var p=s;var P=p.position;var c=p.visible;var l=sap.ui.getCore().getConfiguration().getLocale().toString();var C=window.Intl.Collator(l,{});i.sort(function(f,F){if(f[c]&&F[c]){return(f[P]||0)-(F[P]||0);}else if(f[c]){return-1;}else if(F[c]){return 1;}else if(!f[c]&&!F[c]){return C.compare(f.label,F.label);}});};b.prototype.arrayToMap=function(A){return A.reduce(function(M,p,i){M[p.key]=p;M[p.key].position=i;return M;},{});};b.prototype.destroy=function(){B.prototype.destroy.apply(this,arguments);this._oAdaptationControl=null;this._bLiveMode=null;this._oPanel=null;this._bResetEnabled=null;this._oAdaptationModel=null;};return b;});
